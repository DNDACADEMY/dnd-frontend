name: Storybook

on:
  push:
    branches:
      - main
  pull_request:
    types:
      - labeled

jobs:
  # Main ë¸Œëœì¹˜ì—ì„œ dds-desktop ë³€ê²½ ì—¬ë¶€ ì²´í¬
  check-desktop-main:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.check_changes.outputs.has_changes }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if dds-desktop has changes
        id: check_changes
        run: |
          # ì§ì „ ì»¤ë°‹ê³¼ í˜„ì¬ ì»¤ë°‹ ì‚¬ì´ì—ì„œ dds-desktop ë³€ê²½ì‚¬í•­ í™•ì¸
          if git diff --name-only HEAD^ HEAD | grep -q "^packages/dds-desktop/"; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… dds-desktopì— ë³€ê²½ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤."
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ dds-desktopì— ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤. ë°°í¬ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
          fi

  # Main ë¸Œëœì¹˜ ìë™ ë°°í¬
  deploy-main:
    needs: check-desktop-main
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.check-desktop-main.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Build packages
        run: yarn build:packages

      - name: Publish to Chromatic
        uses: chromaui/action@latest
        with:
          projectToken: ${{ secrets.CHROMATIC_MAIN_PROJECT_TOKEN }}
          workingDir: packages/dds-desktop
          buildScriptName: build-storybook
          autoAcceptChanges: true

  # Alpha ë ˆì´ë¸” ë°°í¬
  deploy-alpha:
    if: github.event_name == 'pull_request' && github.event.action == 'labeled' && github.event.label.name == 'alpha-storybook'
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Build packages
        run: yarn build:packages

      - name: Publish to Chromatic
        id: chromatic
        uses: chromaui/action@latest
        continue-on-error: true
        with:
          projectToken: ${{ secrets.CHROMATIC_ALPHA_PROJECT_TOKEN }}
          workingDir: packages/dds-desktop
          buildScriptName: build-storybook
          autoAcceptChanges: false

      - name: Comment deployment URL
        uses: actions/github-script@v7
        if: steps.chromatic.outcome == 'success'
        with:
          script: |
            const storybookUrl = '${{ steps.chromatic.outputs.storybookUrl }}';
            const buildUrl = '${{ steps.chromatic.outputs.buildUrl }}';
            const prNumber = context.payload.pull_request.number;

            const comment = `## ğŸ¨ ìŠ¤í† ë¦¬ë¶ ì•ŒíŒŒ ë°°í¬ ì™„ë£Œ

            ### ğŸ“¦ ë°°í¬ ì£¼ì†Œ
            - **ìŠ¤í† ë¦¬ë¶:** ${storybookUrl}
            - **ë¹Œë“œ ìƒì„¸:** ${buildUrl}

            ### â„¹ï¸ ì •ë³´
            - PR: #${prNumber}
            - ì›Œí¬í”Œë¡œìš°: [ì‹¤í–‰ ë‚´ì—­ ë³´ê¸°](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });
            console.log(`PR #${prNumber}ì— ì½”ë©˜íŠ¸ ì¶”ê°€ ì™„ë£Œ`);

      - name: Comment deployment failure
        uses: actions/github-script@v7
        if: steps.chromatic.outcome == 'failure'
        with:
          script: |
            const prNumber = context.payload.pull_request.number;

            const comment = `## âŒ ìŠ¤í† ë¦¬ë¶ ì•ŒíŒŒ ë°°í¬ ì‹¤íŒ¨

            ### â„¹ï¸ ì •ë³´
            - PR: #${prNumber}
            - ì›Œí¬í”Œë¡œìš°: [ì‹¤í–‰ ë‚´ì—­ ë³´ê¸°](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})

            ë°°í¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ë‚´ì—­ì„ í™•ì¸í•´ì£¼ì„¸ìš”.
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });
            console.log(`PR #${prNumber}ì— ì‹¤íŒ¨ ì½”ë©˜íŠ¸ ì¶”ê°€ ì™„ë£Œ`);

      - name: Remove alpha-storybook label
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = context.payload.pull_request.number;

            try {
              await github.rest.issues.removeLabel({
                owner,
                repo,
                issue_number: prNumber,
                name: 'alpha-storybook'
              });
              console.log(`âœ… PR #${prNumber}ì—ì„œ 'alpha-storybook' ë ˆì´ë¸” ì‚­ì œ ì™„ë£Œ`);
            } catch (error) {
              if (error.status === 404) {
                console.log(`â„¹ï¸  PR #${prNumber}ì— 'alpha-storybook' ë ˆì´ë¸”ì´ ì—†ìŠµë‹ˆë‹¤ - ì´ë¯¸ ì‚­ì œë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤`);
              } else {
                console.error(`âŒ ë ˆì´ë¸” ì‚­ì œ ì˜¤ë¥˜: ${error.message}`);
                // ë ˆì´ë¸” ì‚­ì œ ì‹¤íŒ¨ëŠ” ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨ë¡œ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ
              }
            }
