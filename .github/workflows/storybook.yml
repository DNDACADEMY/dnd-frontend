name: Storybook

on:
  # Main ë¸Œëœì¹˜ì— pushë  ë•Œ ìë™ ë°°í¬
  push:
    branches:
      - main
    paths:
      - 'packages/dds-desktop/**'
    tags:
      # alpha-storybook íƒœê·¸ê°€ pushë  ë•Œ ì•ŒíŒŒ ë°°í¬
      - 'alpha-storybook'

  # íƒœê·¸ ì‚­ì œë¥¼ ìœ„í•œ ìˆ˜ë™ íŠ¸ë¦¬ê±°
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - delete-alpha-tag
      confirm:
        description: 'Type "delete" to confirm'
        required: false
        default: ''

jobs:
  # Main ë¸Œëœì¹˜ ìë™ ë°°í¬
  deploy-main:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Build packages
        run: yarn build:packages

      - name: Publish to Chromatic
        uses: chromaui/action@latest
        with:
          projectToken: ${{ secrets.CHROMATIC_MAIN_PROJECT_TOKEN }}
          workingDir: packages/dds-desktop
          buildScriptName: build-storybook
          autoAcceptChanges: true

  # Alpha íƒœê·¸ ë°°í¬
  deploy-alpha:
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/alpha-storybook')
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Build packages
        run: yarn build:packages

      - name: Publish to Chromatic
        id: chromatic
        uses: chromaui/action@latest
        continue-on-error: true
        with:
          projectToken: ${{ secrets.CHROMATIC_ALPHA_PROJECT_TOKEN }}
          workingDir: packages/dds-desktop
          buildScriptName: build-storybook
          autoAcceptChanges: false

      - name: Comment deployment URL
        uses: actions/github-script@v7
        if: steps.chromatic.outcome == 'success'
        with:
          script: |
            const storybookUrl = '${{ steps.chromatic.outputs.storybookUrl }}';
            const buildUrl = '${{ steps.chromatic.outputs.buildUrl }}';
            const tagName = context.ref.replace('refs/tags/', '');

            // ê°€ì¥ ìµœê·¼ ì»¤ë°‹ ê°€ì ¸ì˜¤ê¸°
            const commit = context.sha;

            // í•´ë‹¹ ì»¤ë°‹ê³¼ ì—°ê´€ëœ PR ì°¾ê¸°
            const prs = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: commit
            });

            const comment = `## ğŸ¨ ìŠ¤í† ë¦¬ë¶ ì•ŒíŒŒ ë°°í¬ ì™„ë£Œ

            **íƒœê·¸:** \`${tagName}\`
            **ë¸Œëœì¹˜:** \`${context.ref}\`

            ### ğŸ“¦ ë°°í¬ ì£¼ì†Œ
            - **ìŠ¤í† ë¦¬ë¶:** ${storybookUrl}
            - **ë¹Œë“œ ìƒì„¸:** ${buildUrl}

            ### â„¹ï¸ ì •ë³´
            - ì»¤ë°‹: ${commit.substring(0, 7)}
            - ì›Œí¬í”Œë¡œìš°: [ì‹¤í–‰ ë‚´ì—­ ë³´ê¸°](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            `;

            // PRì— ì½”ë©˜íŠ¸ ì¶”ê°€
            if (prs.data.length > 0) {
              const pr = prs.data[0];
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: comment
              });
              console.log(`PR #${pr.number}ì— ì½”ë©˜íŠ¸ ì¶”ê°€ ì™„ë£Œ`);
            } else {
              console.log('ì—°ê´€ëœ PRì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            }

      - name: Comment deployment failure
        uses: actions/github-script@v7
        if: steps.chromatic.outcome == 'failure'
        with:
          script: |
            const tagName = context.ref.replace('refs/tags/', '');
            const commit = context.sha;

            // í•´ë‹¹ ì»¤ë°‹ê³¼ ì—°ê´€ëœ PR ì°¾ê¸°
            const prs = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: commit
            });

            const comment = `## âŒ ìŠ¤í† ë¦¬ë¶ ì•ŒíŒŒ ë°°í¬ ì‹¤íŒ¨

            **íƒœê·¸:** \`${tagName}\`
            **ë¸Œëœì¹˜:** \`${context.ref}\`

            ### â„¹ï¸ ì •ë³´
            - ì»¤ë°‹: ${commit.substring(0, 7)}
            - ì›Œí¬í”Œë¡œìš°: [ì‹¤í–‰ ë‚´ì—­ ë³´ê¸°](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})

            ë°°í¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ë‚´ì—­ì„ í™•ì¸í•´ì£¼ì„¸ìš”.
            `;

            // PRì— ì½”ë©˜íŠ¸ ì¶”ê°€
            if (prs.data.length > 0) {
              const pr = prs.data[0];
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: comment
              });
              console.log(`PR #${pr.number}ì— ì‹¤íŒ¨ ì½”ë©˜íŠ¸ ì¶”ê°€ ì™„ë£Œ`);
            } else {
              console.log('ì—°ê´€ëœ PRì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            }

      - name: Delete alpha-storybook tag
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const tagName = context.ref.replace('refs/tags/', '');
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            try {
              await github.rest.git.deleteRef({
                owner,
                repo,
                ref: `tags/${tagName}`
              });
              console.log(`âœ… íƒœê·¸ ì‚­ì œ ì™„ë£Œ: ${tagName}`);
            } catch (error) {
              if (error.status === 404) {
                console.log(`â„¹ï¸  íƒœê·¸ '${tagName}'ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ - ì´ë¯¸ ì‚­ì œë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤`);
              } else {
                console.error(`âŒ íƒœê·¸ ì‚­ì œ ì˜¤ë¥˜: ${error.message}`);
                // íƒœê·¸ ì‚­ì œ ì‹¤íŒ¨ëŠ” ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨ë¡œ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ
              }
            }

  # Alpha íƒœê·¸ ì‚­ì œ
  delete-alpha-tag:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'delete-alpha-tag'
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Validate confirmation
        if: github.event.inputs.confirm != 'delete'
        run: |
          echo "âŒ íƒœê·¸ ì‚­ì œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤ - í™•ì¸ ì…ë ¥ì´ ì œê³µë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
          echo "ì§„í–‰í•˜ë ¤ë©´ í™•ì¸ ì…ë ¥ë€ì— 'delete'ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”"
          exit 1

      - name: Delete alpha-storybook tag
        if: github.event.inputs.confirm == 'delete'
        uses: actions/github-script@v7
        with:
          script: |
            const tagName = 'alpha-storybook';
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            try {
              await github.rest.git.deleteRef({
                owner,
                repo,
                ref: `tags/${tagName}`
              });
              console.log(`âœ… íƒœê·¸ ì‚­ì œ ì™„ë£Œ: ${tagName}`);
            } catch (error) {
              if (error.status === 404) {
                console.log(`â„¹ï¸  íƒœê·¸ '${tagName}'ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ - ì´ë¯¸ ì‚­ì œë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤`);
              } else {
                console.error(`âŒ íƒœê·¸ ì‚­ì œ ì˜¤ë¥˜: ${error.message}`);
                throw error;
              }
            }
